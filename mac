#!/bin/bash

# Welcome to the Nimble laptop script!
# Be prepared to turn your laptop (or desktop, no haters here)
# into an awesome development machine.

# shellcheck disable=SC2154
trap 'ret=$?; test $ret -ne 0 && printf "failed\n\n" >&2; exit $ret' EXIT

# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -e

fancy_echo() {
  local fmt="$1"; shift

  # shellcheck disable=SC2059
  printf "\n$fmt\n" "$@"
}

pre_setup() {
  if [ ! -f "$HOME/.Brewfile" ]; then
    touch "$HOME/.Brewfile"
  fi

  # Determine Homebrew prefix
  ARCH="$(uname -m)"
  if [ "$ARCH" = "arm64" ]; then
    HOMEBREW_PREFIX="/opt/homebrew"
  else
    HOMEBREW_PREFIX="/usr/local"
  fi
}

gem_install_or_update() {
  if gem list "$1" --installed > /dev/null; then
    gem update "$@"
  else
    gem install "$@"
  fi
}

install_homebrew() {
  if ! command -v brew >/dev/null; then
    fancy_echo "Installing Homebrew ..."
      /bin/bash -c \
        "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      export PATH="$HOMEBREW_PREFIX/bin:$PATH"
  fi

  if brew list | grep -Fq brew-cask; then
    fancy_echo "Uninstalling old Homebrew-Cask ..."
    brew uninstall --force brew-cask
  fi
}

install_chezmoi() {
  if ! command -v chezmoi >/dev/null; then
    fancy_echo "Installing chezmoi and applying dotfiles..."
    sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply jacobpatton
  else
    fancy_echo "Updating dotfiles with chezmoi..."
    chezmoi update
  fi
}

install_mise() {
  if ! command -v mise >/dev/null; then
    fancy_echo "Installing mise..."
    curl https://mise.run | sh
  fi
}

install_mise_languages() {
  fancy_echo "Installing languages via mise..."
  mise install ruby node go

  fancy_echo "Installing global npm packages..."
  npm install -g @anthropic-ai/claude-code @google/generative-ai
}

append_general_dependencies() {
  fancy_echo "Appending general dependencies to Brewfile"

  tee "$HOME/.Brewfile" <<-EOF
    # Taps
    tap "thoughtbot/formulae"
    tap "homebrew/services"
    tap "universal-ctags/universal-ctags"
    tap "github/gh"

    # Unix
    brew "universal-ctags", args: ["HEAD"]
    brew "git"
    brew "openssl"
    brew "gpg"
    brew "zsh"
    brew "fzf"
    brew "tmux"
    brew "reattach-to-user-namespace"
    brew "the_silver_searcher"
    brew "poppler"
    brew "watchman"

    # GitHub extensions
    brew "gh"
    brew "git-lfs"

    # Version control
    brew "jj"

    # Build dependencies
    brew "rust"

    # Programming language prerequisites
    brew "libyaml"
    brew "coreutils"

    # Databases
    brew "postgresql@14"
    brew "pgvector"
    brew "redis"

    # CLI tools
    cask "1password-cli"
    cask "gpg-suite-no-mail"

    # Browser
    cask "eloston-chromium"

    # Terminal
    cask "wezterm"

    # Automation
    cask "hammerspoon"
    cask "karabiner-elements"
    cask "espanso"

    # Productivity
    cask "rectangle"
    cask "alfred"
    cask "bettertouchtool"
    # Keyboard Maestro 10.2: https://files.stairways.com/keyboardmaestro-102.zip
    cask "freedom"

    # Utilities
    # Parachute: https://apps.apple.com/app/parachute/id1436650069
    cask "cleanshot"
    cask "tailscale"
    cask "soundsource"
    cask "jordanbaird-ice"
EOF
}

append_web_dependencies() {
  fancy_echo "Appending web's dependencies to Brewfile"

  tee -a "$HOME/.Brewfile" <<-EOF
    # Web
    tap "heroku/brew"
    tap "phrase/brewed"

    # Devops
    brew "heroku"
    brew "awscli"

    # Image manipulation
    brew "imagemagick"

    # Others
    brew "yarn"
    brew "phrase"
    brew "libpq"
EOF
}

install_dependencies() {
  fancy_echo "Updating Homebrew formulae ..."
  brew update --force # https://github.com/Homebrew/brew/issues/1151

  fancy_echo "Installing dependencies"
  brew bundle --global --verbose --no-upgrade

  fancy_echo "Installed dependencies"
}

install_laptop_local() {
  if [ -f "$HOME/.laptop.local" ]; then
    fancy_echo "Running your customizations from ~/.laptop.local ..."
    # shellcheck disable=SC1090
    . "$HOME/.laptop.local"
  fi
}

install() {
  read -r -p "Do you want to install Web's dependencies? [y|N] " web_dep

  pre_setup
  install_homebrew
  append_general_dependencies

  if [[ $web_dep =~ (y|yes|Y) ]];then
    append_web_dependencies
    install_mise
    install_mise_languages
  fi

  install_dependencies
  install_chezmoi
  install_laptop_local

  brew cleanup
}

# Run
install

fancy_echo "Installation successful"
